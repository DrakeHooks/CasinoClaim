var adawareCloudService=function(){"use strict";var t=vAPI.storage,a=function(t,a){setTimeout(function(){adawareTelemetry.sendEventTrackingInfo(t,a)},5e3)},e={"bing.com":["bing.com"],"defaultsearch.co":["defaultsearch.co"],"lavasoft.com":["lavasoft.com"],"yahoo.com":["yahoo.com"],"seccint.com":["searchfeed.seccint.com"],"adaware.com":["privatesearch.adaware.com","search.adaware.com"]},s=function(){this.whitelistDomains=null,this.blacklistDomains=null,this.metricsDefault={mainFrameRequests:0,averageLatency:0,averageWaits:0,maxWaits:0,averageUrlProcessingTime:0,totalCalls:{ok:0,nonOk:0}},this.metrics={},this.status="ON"};s.prototype.init=function(){var e=null,i=null,n=null,l=null,r=Promise.all([new Promise(function(a,s){t.get({acsWhitelist:null},function(t){e=t.acsWhitelist,a("acsWhitelist")})}),new Promise(function(a,e){t.get({acsBlacklist:null},function(t){i=t.acsBlacklist,a("acsBlacklist")})}),new Promise(function(a,e){t.get({acsWhitelistLastDownloadTime:0},function(t){n=null===t.acsWhitelistLastDownloadTime||void 0===t.acsWhitelistLastDownloadTime?0:t.acsWhitelistLastDownloadTime,a("acsWhitelistLastDownloadTime")})}),new Promise(function(a,e){t.get({acsBlacklistLastDownloadTime:0},function(t){l=null===t.acsBlacklistLastDownloadTime||void 0===t.acsBlacklistLastDownloadTime?0:t.acsBlacklistLastDownloadTime,a("acsBlacklistLastDownloadTime")})})]);this.metrics=function(){var t=objectAssign({},this.metricsDefault),a=vAPI.localStorage.getItem("ACSMetrics");if("string"==typeof a)try{var e=JSON.parse(a);if(e instanceof Object)for(var s in e)t.hasOwnProperty(s)&&(t[s]=e[s])}catch(t){}return t}.bind(this)(),r.then(function(r){var o=Date.now()-n,c=Date.now()-l;0===n&&(o=0),0===l&&(c=0);var m=function(t){for(var a=[],e=0;e<t.length;e++)a.push(YaMD5.hashStr(t[e]));return a},u=function(e,i){var n=m(e);s.whitelistDomains=new Set(n),t.set({acsWhitelist:n}),t.set({acsWhitelistLastDownloadTime:Date.now()}),a("AcsListDownload",{List:"Whitelist",LastUpdate:o/1e3,HttpStatus:i})},h=function(t){a("AcsListDownload",{List:"Whitelist",LastUpdate:o/1e3,HttpStatus:t})},f=function(e,i){var n=m(e);s.blacklistDomains=new Set(n),t.set({acsBlacklist:n}),t.set({acsBlacklistLastDownloadTime:Date.now()}),a("AcsListDownload",{List:"Blacklist",LastUpdate:c/1e3,HttpStatus:i})},v=function(t){a("AcsListDownload",{List:"Blacklist",LastUpdate:c/1e3,HttpStatus:t})};null===e||o>864e5?adawareUtils.getRemoteAsset("https://acs.lavasoft.com/api/v2.0/url/whitelist",u,h):s.whitelistDomains=new Set(e),null===i||c>864e5?adawareUtils.getRemoteAsset("https://acs.lavasoft.com/api/v2.0/url/blacklist",f,v):s.blacklistDomains=new Set(i);setInterval(function(){adawareUtils.getRemoteAsset("https://acs.lavasoft.com/api/v2.0/url/whitelist",u,h),adawareUtils.getRemoteAsset("https://acs.lavasoft.com/api/v2.0/url/blacklist",f,v)},864e5)})};return s.prototype.filterRequest=function(t,a,i){this.metrics.mainFrameRequests++;var n,l,r,o,c="";if("localhost"===t.pageDomain)return"";if(null==s.whitelistDomains)return"ua:uninitialized-acs-asset";if(n=t.requestURL,l=t.requestHostname,r=function(t,a,e){return-1===e.indexOf("/")?a.endsWith(e)&&(a.length===e.length||"."===a.charAt(a.length-e.length-1)):!1===e.startsWith("/")&&-1===e.indexOf("*")?t===e:void 0},o=function(t,a,e,s){if(e)for(var i=s||0,n=e.length;i<n;i++)if(r(t,a,e[i]))return i;return-1},!function(t,a){for(var s,i=a;;){if(-1!==o(t,a,e[i]))return!1;if(-1===(s=i.indexOf(".")))break;i=i.slice(s+1)}return-1===o(t,a,e["//"])}(n,l))return"";var m=t.pageDomain;t.pageDomain.startsWith("www.")&&(m=t.pageDomain.replace("www.",""));var u=YaMD5.hashStr(m),h=YaMD5.hashStr(t.requestHostname);if(s.whitelistDomains.has(u)||s.whitelistDomains.has(h));else{var f=!1,v=!1,w=!1;null!=s.blacklistDomains&&(v=s.blacklistDomains.has(h),w=s.blacklistDomains.has(u)),(v||w)&&(c="acs-black-list-hit",f=!0);if("ON"===this.status)acsRequestManager.createInstance().send("url="+encodeURIComponent(t.requestURL),a,i,f,function(t){this.metrics.averageWaits=adawareUtils.computeMovingAverage(this.metrics.mainFrameRequests,this.metrics.averageWaits,t.waitCounter),this.metrics.maxWaits=Math.max(this.metrics.maxWaits,t.waitCounter),this.metrics.totalCalls.ok+=t.callCount.ok,this.metrics.totalCalls.nonOk+=t.callCount.nonOk,this.metrics.averageUrlProcessingTime=adawareUtils.computeMovingAverage(this.metrics.mainFrameRequests,this.metrics.averageUrlProcessingTime,t.mainFrameRequestProcessingTime),this.metrics.averageLatency=adawareUtils.computeMovingAverage(this.metrics.mainFrameRequests,this.metrics.averageLatency,t.averageXhrLatency),vAPI.localStorage.setItem("ACSMetrics",JSON.stringify(this.metrics))}.bind(this))}return c},s.prototype.filterUrlsRequest=function(t){var a={validUrls:{},unvalidUrls:{}};for(var e in t)s.blacklistDomains.has(YaMD5.hashStr(t[e]))?a.unvalidUrls[e]=t[e]:a.validUrls[e]=t[e];return a},s.prototype.getMetrics=function(){return{ACSAvgLatency:this.metrics.averageLatency,ACSTotalCalls:this.metrics.totalCalls.ok+this.metrics.totalCalls.nonOk,ACSNon200:this.metrics.totalCalls.nonOk,ACSAvgWait:this.metrics.averageWaits,ACSMaxWait:this.metrics.maxWaits,ACSAvgUrlProcessingTime:this.metrics.averageUrlProcessingTime}},s.prototype.resetMetrics=function(){var t=function(a){for(var e in a)a.hasOwnProperty(e)&&("object"==typeof a[e]&&null!==a[e]?t(a[e]):a[e]=0)};t(this.metrics)},new s}();